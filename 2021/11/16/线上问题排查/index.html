<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Microsoft YaHei:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="本文为自己前段时间解决线上的两个疑难问题，而后复盘整理的一次技术分享。  内存泄漏之线程泄漏 WebClient连接池问题  技术背景：Java、Spring Webflux、Reactor">
<meta property="og:type" content="article">
<meta property="og:title" content="线上问题排查复盘">
<meta property="og:url" content="http://flyen.github.io/2021/11/16/线上问题排查/index.html">
<meta property="og:site_name" content="flyEn&#39;blog">
<meta property="og:description" content="本文为自己前段时间解决线上的两个疑难问题，而后复盘整理的一次技术分享。  内存泄漏之线程泄漏 WebClient连接池问题  技术背景：Java、Spring Webflux、Reactor">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211112111844772.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211112111910069.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211112113646441.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211108104858038.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211108114153802.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211108115901034.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211109153630433.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110100036900.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110101955091.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110101743684.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110103444921.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110103525625.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110103847720.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110103942395.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110104226447.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110104412559.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110110401242.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110110557287.png">
<meta property="og:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211110110645454.png">
<meta property="og:updated_time" content="2021-11-16T06:29:54.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="线上问题排查复盘">
<meta name="twitter:description" content="本文为自己前段时间解决线上的两个疑难问题，而后复盘整理的一次技术分享。  内存泄漏之线程泄漏 WebClient连接池问题  技术背景：Java、Spring Webflux、Reactor">
<meta name="twitter:image" content="http://flyen.github.io/2021/11/16/线上问题排查/image-20211112111844772.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://flyen.github.io/2021/11/16/线上问题排查/"/>





  <title> 线上问题排查复盘 | flyEn'blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">flyEn'blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://flyen.github.io/2021/11/16/线上问题排查/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Iwhale">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="flyEn'blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="flyEn'blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                线上问题排查复盘
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-11-16T13:41:32+08:00">
                2021-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文为自己前段时间解决线上的两个疑难问题，而后复盘整理的一次技术分享。</p>
<ol>
<li>内存泄漏之线程泄漏</li>
<li>WebClient连接池问题</li>
</ol>
<p>技术背景：Java、Spring Webflux、Reactor<br><a id="more"></a></p>
<h2 id="1-open服务内存溢出频繁重启"><a href="#1-open服务内存溢出频繁重启" class="headerlink" title="1. open服务内存溢出频繁重启"></a>1. open服务内存溢出频繁重启</h2><p>通过线上内存资源用尽的过程中导出来的dump文件，进行分析。</p>
<blockquote>
<p>命令：<code>jcmd 1 Dump.java &lt;dump_file_name&gt;</code>，生成<code>.dump</code>后缀的dump文件。<br>（jdk版本：adoptOpenJDK-openj9）<br>在线分析： <a href="https://fastthread.io/" target="_blank" rel="noopener">https://fastthread.io/</a> </p>
</blockquote>
<p>如下图，发现线程数3215，可以看到分析出来的提示。（过高的线程数可能会导致OOM）</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211112111844772.png" alt="image-20211112111844772"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211112111910069.png" alt="image-20211112111910069"></p>
<p>从这边看到 <code>boundedElastic、baidu</code> 这两个线程组是非常多的，而且接近1：1的程度。</p>
<p> <u>通过<code>baidu</code>这个可疑的名称</u>，查到了 百度切面 (<code>BaiduRequestAspect.java</code>)中有一行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Mono.subscriberContext()</span><br><span class="line">    .publishOn(Schedulers.elastic())</span><br><span class="line">    .map(ctx -&gt; ctx.get(ServerHttpRequest.class))</span><br><span class="line">    .flatMap(serverHttpRequest -&gt; &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> openCommonService.getOpenAppByIdAndCheck(baiduSignData.getCipherid())</span><br><span class="line">                .publishOn(Schedulers.newParallel(<span class="string">"baidu"</span>))</span><br><span class="line">                .flatMap(...)</span><br></pre></td></tr></table></figure>
<p>找到两处可疑点。</p>
<ol>
<li><code>.publishOn(Schedulers.elastic())</code></li>
<li><code>.publishOn(Schedulers.newParallel(&quot;baidu&quot;))</code></li>
</ol>
<h3 id="Schedulers-elastic"><a href="#Schedulers-elastic" class="headerlink" title="Schedulers.elastic()"></a>Schedulers.elastic()</h3><p>首先，查看了下 <code>.publishOn(Schedulers.elastic())</code> 的解释。</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211112113646441.png" alt="image-20211112113646441"></p>
<p>弹性线程池，以下是<code>.publishOn(Schedulers.elastic())</code>这个方法的注释，可以看到两点：<strong>1.创建线程池的线程数量是不限制的；2.空闲时间60s之后会被废弃。</strong>（相当于也没有任务队列）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Scheduler&#125; that dynamically creates ExecutorService-based Workers and caches</span></span><br><span class="line"><span class="comment"> * the thread pools, reusing them once the Workers have been shut down.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The maximum number of created thread pools is unbounded.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The default time-to-live for unused thread pools is 60 seconds, use the appropriate</span></span><br><span class="line"><span class="comment"> * factory to set a different value.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This scheduler is not restartable.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> default instance of a &#123;<span class="doctag">@link</span> Scheduler&#125; that dynamically creates ExecutorService-based</span></span><br><span class="line"><span class="comment"> * Workers and caches the threads, reusing them once the Workers have been shut</span></span><br><span class="line"><span class="comment"> * down</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span> use &#123;<span class="doctag">@link</span> #boundedElastic()&#125;, to be removed in 3.5.0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>可以看到3.5.0之后这个是被废弃了，后面用<code>Schedulers.boundedElastic()</code>代替，<code>boundedElastic()</code>是限制线程池的线程数量最大为CPU核的10倍，任务队列默认最多10万个（可以通过去查看该方法的注释看出）。</p>
<p><strong>所以可以看出来一个问题，<code>Schedulers.elastic()</code>线程数不限制，对于线程数一直累加肯定是会有所影响的。</strong></p>
<p>这个是可以用<code>Schedulers.boundedElastic()</code>去优化的。</p>
<p>但是比较奇怪的是 <u>为什么创建的线程没有被销毁的</u>。</p>
<p>对于这个问题，在第一次优化修改的时候还是有所疑问。</p>
<h3 id="Schedulers-newParallel"><a href="#Schedulers-newParallel" class="headerlink" title="Schedulers.newParallel()"></a>Schedulers.newParallel()</h3><p>还有比较明显的一行就是 <code>Schedulers.newParallel(&quot;baidu&quot;)</code> ，每次请求进来，都分出一个线程来处理后续请求，线程组名为<strong>baidu</strong>，也和上面分析出来的对上了。</p>
<blockquote>
<p>说明下为什么以前要加分线程来处理请求的背景。</p>
<p>为了解决之前 调用 同步/阻塞接口（腾讯报告获取接口），因为要转成base64，是阻塞方法。返回时长也比较久。导致其他open接口在其返回之前不可用，也一同被阻塞。</p>
</blockquote>
<p>关于这个 <code>Schedulers.newParallel(..)</code>这个问题，这种new一个的形式都是新建一个调度器（而不是一个线程），<code>Parallel()</code>是固定线程大小的线程池，有固定的worker数，一个<code>worker</code>代表调度器可调度的工作线程。</p>
<p><strong>但对于我们现在这种场景，是请求进来应该是服用一个调度器，去分配任务给工作线程去处理。而不是每一个请求去新建一个调度器（调度器是至少一个线程存活的），如果没有任务进去就是一直waiting状态。</strong></p>
<p>所以这种写法也导致了我们 <code>baidu</code> 这个线程组有那么多的线程实例的问题所在。</p>
<blockquote>
<p><code>Schedulers</code>类已经预先创建了几种常用的不同线程池模型的调度器：使用<code>single()</code>、<code>elastic()</code>和<code>parallel()</code>方法创建的调度器可以分别使用<u>内置</u>的单线程、弹性线程池和固定大小线程池。如果想创建新的调度器，可以使用<code>newSingle()</code>、<code>newElastic()</code>和<code>newParallel()</code>方法。这些方法都是返回一个<code>Scheduler</code>的具体实现。</p>
</blockquote>
<p>本地通过去创建了个测试类，也验证了这一点。</p>
<h3 id="第一次改动"><a href="#第一次改动" class="headerlink" title="第一次改动"></a>第一次改动</h3><ol>
<li>首先，<code>Schedulers.elastic()</code>是个弹性线程池，内置的已经创建的调度器，且线程可复用，应用在每次请求上是没有问题的，但是因为线程数量不限制（本来也是废弃了的方法），<u>所以应该更改为 <code>Schedulers.boundedElastic()</code>。</u></li>
<li>第二，看到百度切面上是<u>处理了两次分线程</u>，是完全没有必要的（相当于一个请求进来，又分了两个线程去处理），只需要分一次就行（腾讯切面是仅分了一次）。</li>
<li>第三，<code>newParallel</code>这种写法要避免。所以将<code>Schedulers.newParallel(&quot;baidu&quot;)</code>换成 <code>Schedulers.boundedElastic()</code>，将上面的 <code>.publishOn(Schedulers.elastic())</code>删除。</li>
</ol>
<p>最后<u>腾讯切面</u>将<code>Schedulers.elastic()</code>改为 <code>Schedulers.boundedElastic()</code>。</p>
<p><u>百度切面</u>改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Mono.subscriberContext() <span class="comment">// 去除下面的分线程</span></span><br><span class="line">    .map(ctx -&gt; ctx.get(ServerHttpRequest.class))</span><br><span class="line">    .flatMap(serverHttpRequest -&gt; &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> openCommonService.getOpenAppByIdAndCheck(baiduSignData.getCipherid())</span><br><span class="line">                .publishOn(Schedulers.boundedElastic())  <span class="comment">// 去除newParallel写法</span></span><br><span class="line">                .flatMap(...)</span><br></pre></td></tr></table></figure>
<h4 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h4><p>上到沙箱去压测。</p>
<p>压测了百度核酸的查库存接口，发现线程数还是会一直增长。主要是线程组<code>boundedElastic</code>一直增长，baidu这个线程组是已经没有了。</p>
<p>所以还有个问题没有解决掉，就是 <strong>为什么弹性线程池里创建出来的线程是没有被销毁的</strong>。</p>
<p>当时很自然的以为 是我们用了 <code>.publishOn(Schedulers.boundedElastic())</code>的缘故。所以之后我把所有的分线程的代码给去除了，继续上了沙箱去压测。</p>
<p><u>去除所有分线程处理后，压测结果：</u></p>
<p>发版后，线程数105。</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211108104858038.png" alt="image-20211108104858038"></p>
<p>压测<u>百度核酸的查库存接口</u> 11:19-11:29十分钟，并发200，每秒用户数20。</p>
<p>压测前内存：<strong>580M</strong>，压测后内存：<strong>1.655G</strong>。</p>
<p>跑完看了下进程1的线程数有<strong>11863</strong>，还不会回收线程。（在过了<u>20分钟/下午13:42</u>之后再看，还是一样的）</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211108114153802.png" alt="image-20211108114153802"></p>
<p>结果和预想的不同，和代码中写的 <code>.publishOn(Schedulers.boundedElastic())</code> 并没有关系。</p>
<p>所有<u><strong>怀疑是不是我们切面写法有问题，也是比较费解</strong></u>。</p>
<p>后来压测了下<strong>mobile</strong>服务的，压测前线程数：119</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211108115901034.png" alt="image-20211108115901034"></p>
<p>压测12:03-12:06(3分钟)，内存基本上没增加什么，差不多20m的样子，最后总共线程数126。</p>
<p>因为百度和腾讯的切面是不同的，所以再去压了下 <u>腾讯的查库存接口</u> (13:47-13:50，3分钟)，发现内存没有持续升高，线程数也是没有怎么增加，内存：<strong>1.671G</strong>，线程数：<strong>11867</strong>。（只是多了4个线程数）</p>
<p>不知道是不是<u>线程复用</u>了的情况，还是腾讯切面的效果。所以再一次测了<u>百度的接口</u>。</p>
<p><strong>结果就是刚开始一压，内存就开始飙升，线程数也马上涨了很快，才几秒就到了12185。</strong></p>
<p>所有结果就是，<strong><u>只有请求百度的接口才会出现这个问题</u></strong>。</p>
<p>怀疑是百度切面写法问题，然后去本地进行各种验证。</p>
<p>百度的每次请求都会新增一个线程(无一例外)，并且不回收，一直在<strong>waiting</strong>状态。而腾讯的是正常的，会增加线程，但多请求是会复用/回收的（基本最后也就多几个）。</p>
<p>通过多种验证，最后发现<strong>：<u>与切面代码也没有关系 ，与通用返回处理也无关，是百度的接口 请求头有关<code>Content-Type</code> ，只要是这个类型<code>application/x-www-form-urlencoded</code>的参数值，去请求接口，都是会创建出来一个新线程（<code>boundedElastic-xx</code>），并且不会回收</u>。</strong></p>
<p>问题定位完成，与<code>Content-Type:application/x-www-form-urlencoded</code>有关。</p>
<h3 id="application-x-www-form-urlencoded"><a href="#application-x-www-form-urlencoded" class="headerlink" title="application/x-www-form-urlencoded"></a>application/x-www-form-urlencoded</h3><p>经查阅，怀疑可能是框架内部的处理HTTP请求的消息体解析器，是阻塞同步的。</p>
<p>尝试更换配置，尝试切换其他的解析器去解析。可能也是没有找到对应的，总之试了一些配置修改，没有效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">WebFluxConfigurer <span class="title">webFluxConfigurer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WebFluxConfigurer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureHttpMessageCodecs</span><span class="params">(ServerCodecConfigurer configurer)</span> </span>&#123;</span><br><span class="line">            FormHttpMessageReader formHttpMessageReader = <span class="keyword">new</span> FormHttpMessageReader();</span><br><span class="line">            configurer.customCodecs().reader(formHttpMessageReader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>HTTP消息编解码</strong></p>
<p>spring-web模块定义HttpMessageReader和HttpMessageWriter协议，通过Rective Streams Publisher’s对HTTP请求和响应的主体进行编码和解码。 这些行为在客户端使用，例如， 在WebClient中，在服务器端，例如 在注解的控制器和功能端点中。</p>
<p>Spring-core模块定义了独立于HTTP的Encoder和Decoder，并依赖于（如Netty ByteBuf和java.nio.ByteBuffer（请参阅数据缓冲区和编解码器））的DataBuffer协议。 Encoder可以用EncoderHttpMessageWriter包装以用作HttpMessageWriter，而Decoder可以用DecoderHttpMessageReader包装以用作HttpMessageReader。</p>
<p>Spring-core模块包含byte []，ByteBuffer，DataBuffer，Resource和String的基本编码器和解码器实现。 Spring-Web模块为Jackson JSON，Jackson Smile和JAXB2增加了Encoder和Decoder。 Spring-Web模块还包含一些针对服务器发送事件，表单数据和多部分请求的特定于Web的readers 和writers 。</p>
<p><u>要配置或自定义readers 和writers ，通常会使用ClientCodecConfigurer或ServerCodecConfigurer。</u></p>
<p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-form-data" target="_blank" rel="noopener">https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-form-data</a></p>
<p><a href="https://s0docs0spring0io.4x5.top/spring-framework/docs/5.2.x/spring-framework-reference/web-reactive.html#webflux-codecs" target="_blank" rel="noopener">https://s0docs0spring0io.4x5.top/spring-framework/docs/5.2.x/spring-framework-reference/web-reactive.html#webflux-codecs</a></p>
</blockquote>
<p><u>后面还是通过线程这块的角度来尝试解决这个问题。</u></p>
<p>经过测试，每请求一次百度接口，会多一个<code>boundedElastic</code>为前缀的线程，如下图，而且线程是不会Finished，一直在<strong>park</strong>状态。</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211109153630433.png" alt="image-20211109153630433"></p>
<p>然后去Chrome查了下，关键词：<code>boundedElastic Threads park</code></p>
<blockquote>
<p>网上也有类似的问题：<br><a href="https://stackoverflow.com/questions/65262816/webflux-lots-of-boundedelastic-evictor-timed-waiting" target="_blank" rel="noopener">https://stackoverflow.com/questions/65262816/webflux-lots-of-boundedelastic-evictor-timed-waiting</a></p>
<p>最后，确认是框架的bug。<br><a href="https://github.com/spring-projects/spring-framework/issues/26263" target="_blank" rel="noopener">https://github.com/spring-projects/spring-framework/issues/26263</a></p>
</blockquote>
<p>框架内部：<br><a href="https://github.com/spring-projects/spring-framework/blob/499be70a717b8d20c544bc2eac4fe5dacedc7f28/spring-web/src/main/java/org/springframework/http/codec/support/ServerDefaultCodecsImpl.java#L72" target="_blank" rel="noopener">spring-framework/spring-web/src/main/java/org/springframework/http/codec/support/ServerDefaultCodecsImpl.java</a></p>
<p>服务端的消息解码器，内部有个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">extendTypedReaders</span><span class="params">(List&lt;HttpMessageReader&lt;?&gt;&gt; typedReaders)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.multipartReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">		addCodec(typedReaders, <span class="keyword">this</span>.multipartReader);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DefaultPartHttpMessageReader partReader = <span class="keyword">new</span> DefaultPartHttpMessageReader(); <span class="comment">// 这一行</span></span><br><span class="line">	addCodec(typedReaders, partReader);</span><br><span class="line">	addCodec(typedReaders, <span class="keyword">new</span> MultipartHttpMessageReader(partReader));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取消息数据的时候，new一个<code>DefaultPartHttpMessageReader()</code>实例，而</p>
<p><a href="https://github.com/spring-projects/spring-framework/blob/499be70a717b8d20c544bc2eac4fe5dacedc7f28/spring-web/src/main/java/org/springframework/http/codec/multipart/DefaultPartHttpMessageReader.java#L77" target="_blank" rel="noopener">spring-framework/spring-web/src/main/java/org/springframework/http/codec/multipart/DefaultPartHttpMessageReader.java</a></p>
<p>这个类内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPartHttpMessageReader</span> <span class="keyword">extends</span> <span class="title">LoggingCodecSupport</span> <span class="keyword">implements</span> <span class="title">HttpMessageReader</span>&lt;<span class="title">Part</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IDENTIFIER = <span class="string">"spring-multipart"</span>;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Scheduler blockingOperationScheduler = Schedulers.newBoundedElastic(Schedulers.DEFAULT_BOUNDED_ELASTIC_SIZE,</span><br><span class="line">			Schedulers.DEFAULT_BOUNDED_ELASTIC_QUEUESIZE, IDENTIFIER, <span class="number">60</span>, <span class="keyword">true</span>);  <span class="comment">// 这一行</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Mono&lt;Path&gt; fileStorageDirectory = Mono.defer(<span class="keyword">this</span>::defaultFileStorageDirectory).cache();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以可以看到，每次new这个对象的时候，都会调用 <code>Schedulers.newBoundedElastic()</code>的这个方法去创建了一个弹性线程池的调度器。</p>
<p>跟上述所说的<code>newParallel()</code>类似，总的来说，这个调度器一旦创建，是跟着进程销毁的，调度器里至少会存在一个work线程。</p>
<p>所以，谜底终于解开了。</p>
<h3 id="第二次改动"><a href="#第二次改动" class="headerlink" title="第二次改动"></a>第二次改动</h3><p>可以通过以下这种修改配置的方式，指定一个<code>multipartReader</code>给它，根据上述源码，是会走进if分支的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFlux</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebFluxConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureHttpMessageCodecs</span><span class="params">(ServerCodecConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        DefaultPartHttpMessageReader multipartReader = <span class="keyword">new</span> DefaultPartHttpMessageReader();</span><br><span class="line">        configurer.defaultCodecs().multipartReader(multipartReader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这样修改的话，还是有所弊端吧，这样的话这个实例是跟着open服务启动就已经创建出来了，可能不一定是被用到，但是如果是在线程内部创建的话，是跟着线程的生命周期进行创建并销毁的。</p>
<p>但最后还是通过升级了Spring框架版本来解决这个问题：从<strong>2.4.1 升到了 2.4.7</strong>。</p>
<h4 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h4><p>改完之后上到沙箱测了遍 <u>百度的接口</u>：（总并发数200，每秒20，9:59-10:16，18分钟）</p>
<p>压测前：<strong>内存 738.1MB</strong>。线程数没看，基本上70/80的样子。</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110100036900.png" alt="image-20211110100036900"></p>
<p>压测完：<strong>内存833.8M，线程数124</strong>。（过了10多分钟再看内存已经降到800M了）</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110101955091.png" alt="image-20211110101955091"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110101743684.png" alt="image-20211110101743684"></p>
<p>分析压测完的dump文件：121个线程。</p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110103444921.png" alt="image-20211110103444921"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110103525625.png" alt="image-20211110103525625"></p>
<p><strong>压测报告：</strong></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110103847720.png" alt="image-20211110103847720"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110103942395.png" alt="image-20211110103942395"></p>
<p>也压了一遍 <u>腾讯的接口</u> （10:32-10.42，10分钟）。</p>
<p>压测完。<strong>内存722.1M，线程128</strong>。（内存没有升反降了，线程涨了4），<strong>RPS-19.5</strong></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110104226447.png" alt="image-20211110104226447"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110104412559.png" alt="image-20211110104412559"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110110401242.png" alt="image-20211110110401242"></p>
<p>和百度的压测报告差不多。</p>
<p>最后试了下百度核酸的参数比较大的压力测。（10:49-10:59，十分钟）</p>
<p>总并发数1000，每秒启动100，压完，<strong>内存1.072G，线程125</strong>，报告如下：<strong>RPS-73.1</strong></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110110557287.png" alt="image-20211110110557287"></p>
<p><img src="//flyen.github.io/2021/11/16/线上问题排查/image-20211110110645454.png" alt="image-20211110110645454"></p>
<p>问题已解决。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>对于调度器、线程池的了解加深，避免随意使用 <code>`newSingle()</code>、<code>newElastic()</code>和<code>newParallel()</code>等方法。</li>
<li>线上性能监控 、内存泄漏的问题排查、dump文件的分析经验。jdk自带的调优工具(<code>jps/jmap/jcmd</code>等)及啊arthas监控使用、熟悉使用visualvm 、MAT、或者其他在线分析工具。</li>
</ol>
<blockquote>
<p>相关命令：</p>
<p><code>jcmd 1 Dump.java &lt;dump_file_name&gt;</code>，生成<code>.dump</code>后缀的dump文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; `jcmd &lt;pid&gt; GC.heap_dump dump.hprof` 等价于 `jmap -dump:live,format=b,file=dump.hprof &lt;pid&gt;`</span><br><span class="line">&gt; `jcmd &lt;pid&gt; GC.heap_dump -all dump.hprof` 等价于 `jmap -dump:format=b,file=dump.hprof &lt;pid&gt;`</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>监控：<code>docker stats</code><br>查看：<code>docker service ls</code></p>
<p>下载dump文件：<code>docker exec -it de8712e06efe jcmd 1 Dump.java sandbox2-11101022.dump</code><br>容器里复制到外面服务器：<code>docker cp d63a1830a3d2:sandbox2-11081057.dump .</code><br>将服务器下的某文件下载到本地：<code>scp sandbox2:/root/sandbox2-11081057.dump ~/Downloads</code></p>
<p>下载arthas至容器并运行：<br><code>docker exec -it  ${containerId} sh-c &quot;wget https://arthas.aliyun.com/arthas-boot.jar &amp;&amp; java -jar arthas-boot.jar&quot;</code><br>或者已经下载下来，直接运行：<code>java -jar arthas-boot.jar</code><br>或者直接放入项目的Dockerfile中，build构建容器的时候自动下载。</p>
<p>arthas文档： <a href="https://arthas.gitee.io/advanced-use.html" target="_blank" rel="noopener">https://arthas.gitee.io/advanced-use.html</a> </p>
</blockquote>
<h2 id="2-Connection-reset-by-peer"><a href="#2-Connection-reset-by-peer" class="headerlink" title="2. Connection reset by peer"></a>2. Connection reset by peer</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readAddress(..) failed: Connection reset by peer; nested exception is io.netty.channel.unix.Errors$NativeIoException: readAddress(..) failed: Connection reset by peer</span><br></pre></td></tr></table></figure>
<p>之前webclient进行服务间调用的时候，会偶现这个问题。</p>
<p>一般情况下都是在 隔了比较长一段时间，没有去访问的时候会报错。</p>
<p>上半年的时候为了解决这个问题，open的服务间调用直接砍掉了，改成了service内部调用。</p>
<p>之前粗略的统计了下，还有以下部分还剩余webClient方式的调用：</p>
<ol>
<li><p>H5有相对多的没有去完</p>
<blockquote>
<p>医院、发票、报告邮寄、团检、金投、微医登录</p>
</blockquote>
</li>
<li><p>open基本上已经去完了</p>
<blockquote>
<p>顺丰获取海鸥快递订单(OpenSfCall)、调鼎open推送接口</p>
</blockquote>
</li>
<li><p>platform也有一部分没有去完</p>
<blockquote>
<p>大部分是各种联动套餐自动上下线、isp之类的、接口推送渠道(废弃)。</p>
<p>团检预约、套餐等接口</p>
</blockquote>
</li>
<li><p>短信模板参数获取（报告、优惠券）</p>
</li>
<li><p>BeeCloud获取openAPP信息（BCPayAppComponet）</p>
<blockquote>
<p>获取支付参数、BeeCloud退款等（但是rest接口内部没有同步代码块，因此可能不会影响）</p>
</blockquote>
</li>
<li><p>渠道中心（基本上废弃）</p>
</li>
<li><p>医院中心</p>
</li>
<li><p>售后团检部分</p>
</li>
</ol>
<p>经过调研，<strong>改了些 webclient建立连接的参数</strong>，之后经过长时间监控，问题应该已经解决。</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/issues/1774" target="_blank" rel="noopener">https://github.com/reactor/reactor-netty/issues/1774</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ConnectionProvider provider = ConnectionProvider.builder(<span class="string">"fixed"</span>)</span><br><span class="line">    .maxConnections(<span class="number">500</span>)</span><br><span class="line">    .maxIdleTime(Duration.ofSeconds(<span class="number">20</span>))</span><br><span class="line">    .maxLifeTime(Duration.ofSeconds(<span class="number">60</span>))</span><br><span class="line">    .pendingAcquireTimeout(Duration.ofSeconds(<span class="number">60</span>))</span><br><span class="line">    .evictInBackground(Duration.ofSeconds(<span class="number">120</span>)).build();</span><br><span class="line"><span class="keyword">return</span>  builder.clientConnector(<span class="keyword">new</span> ReactorClientHttpConnector(HttpClient.create(provider))).build();</span><br></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/10/09/redis-cluster/" rel="next" title="redis docker swarm 集群部署">
                <i class="fa fa-chevron-left"></i> redis docker swarm 集群部署
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Iwhale" />
          <p class="site-author-name" itemprop="name">Iwhale</p>
          <p class="site-description motion-element" itemprop="description">Dream, Such as whales to the sea.</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/flyEn" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/p/1005055406757796/home" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-open服务内存溢出频繁重启"><span class="nav-number">1.</span> <span class="nav-text">1. open服务内存溢出频繁重启</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Schedulers-elastic"><span class="nav-number">1.1.</span> <span class="nav-text">Schedulers.elastic()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Schedulers-newParallel"><span class="nav-number">1.2.</span> <span class="nav-text">Schedulers.newParallel()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第一次改动"><span class="nav-number">1.3.</span> <span class="nav-text">第一次改动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#测试结果"><span class="nav-number">1.3.1.</span> <span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#application-x-www-form-urlencoded"><span class="nav-number">1.4.</span> <span class="nav-text">application/x-www-form-urlencoded</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二次改动"><span class="nav-number">1.5.</span> <span class="nav-text">第二次改动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#测试结果-1"><span class="nav-number">1.5.1.</span> <span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.6.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Connection-reset-by-peer"><span class="nav-number">2.</span> <span class="nav-text">2. Connection reset by peer</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy;  Thu Jan 05 2017 08:00:00 GMT+0800 (中国标准时间) - 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Iwhale</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  

  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
<script type="text/javascript" src="//7u2ss1.com1.z0.glb.clouddn.com/love.js"></script>

<a href="https://github.com/flyEn"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/c6625ac1f3ee0a12250227cf83ce904423abf351/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png"></a>
</body>
</html>
