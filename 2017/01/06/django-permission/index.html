<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Microsoft YaHei:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="django-primission," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="1.    User ModelDjango内置的权限系统包括以下三个部分：

用户（Users）
许可（Permissions）：用来定义一个用户（user）是否能够做某项任务（task）
组（Groups）：一种可以批量分配许可到多个用户的通用方式">
<meta property="og:type" content="article">
<meta property="og:title" content="django中内置的权限控制">
<meta property="og:url" content="http://yoursite.com/2017/01/06/django-permission/index.html">
<meta property="og:site_name" content="flyEn'blog">
<meta property="og:description" content="1.    User ModelDjango内置的权限系统包括以下三个部分：

用户（Users）
许可（Permissions）：用来定义一个用户（user）是否能够做某项任务（task）
组（Groups）：一种可以批量分配许可到多个用户的通用方式">
<meta property="og:updated_time" content="2017-01-06T03:06:34.936Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="django中内置的权限控制">
<meta name="twitter:description" content="1.    User ModelDjango内置的权限系统包括以下三个部分：

用户（Users）
许可（Permissions）：用来定义一个用户（user）是否能够做某项任务（task）
组（Groups）：一种可以批量分配许可到多个用户的通用方式">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/01/06/django-permission/"/>





  <title> django中内置的权限控制 | flyEn'blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">flyEn'blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/06/django-permission/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Iwhale">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="flyEn'blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="flyEn'blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                django中内置的权限控制
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-06T10:31:38+08:00">
                2017-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/django/" itemprop="url" rel="index">
                    <span itemprop="name">django</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="1-User-Model"><a href="#1-User-Model" class="headerlink" title="1.    User Model"></a>1.    User Model</h3><p>Django内置的权限系统包括以下三个部分：</p>
<ol>
<li>用户（Users）</li>
<li>许可（Permissions）：用来定义一个用户（user）是否能够做某项任务（task）</li>
<li>组（Groups）：一种可以批量分配许可到多个用户的通用方式</li>
</ol>
<a id="more"></a>
<p>首先需要在Django中安装这个组件：</p>
<ol>
<li>将’django.contrib.auth’和’django.contrib.contenttypes’放到settings.py中的INSTALLED_APPS中。（使用contenttypes的原因是auth中的Permission模型依赖于contenttypes）</li>
<li>执行数据库迁移</li>
</ol>
<p><strong>‘django.contrib.auth.models’</strong>里User模型有两个多对多的属性：groups和user_permissions</p>
<blockquote>
<p>【例】es = User.objects.create_user(‘esperyong’,’esperyong@gmail.com’,’123456’)<br>1.直接将一个列表赋值给该属性：<br>es.groups = [group_list]<br>es.user_permissions = [permission_list]<br>2.使用add方法将对象加入：<br>es.groups.add(group, group, …)<br>es.user_permissions.add(permission, permission, …)<br>3.使用remove方法将对象删除：<br>es.groups.remove(group, group, …)<br>es.user_permissions.remove(permission, permission, …)<br>4.使用clear方法将所有对象删除：<br>es.groups.clear()<br>es.user_permissions.clear()</p>
</blockquote>
<p>User对象有以下几个属性：</p>
<ol>
<li>username:字符串类型。必填。30个字符以内。</li>
<li>first_name:字符串类型。可选。30个字符以内。</li>
<li>last_name:字符串类型。可选。30个字符以内。</li>
<li>email:可选。</li>
<li>password:明文密码的hash或者是某种元数据。</li>
<li><code>is_staff</code>:Boolean类型。用这个来判断是否用户可以登录进入admin site。</li>
<li><code>is_active</code>:Boolean类型。用来判断该用户是否是可用激活状态。在删除一个帐户的时候，可以选择将这个属性置为False，而不是真正删除。这样如果应用有外键引用到这个用户，外键就不会被破坏。</li>
<li><code>is_superuser</code>:Boolean类型。该属性用来表示该用户拥有所有的许可，而无需明确的赋予给他。</li>
<li><code>last_login</code>:datetime类型。最近一次登陆时间。</li>
<li>date_joined：datetime类型。创建时间。</li>
</ol>
<p>除了DjangoModel对象的通用方法之外，User对象有以下特有方法：</p>
<ol>
<li>is_anonymous():<br>永远返回False.用来将User对象和AnonymousUser(未登录的匿名用户)对象作区分用的识别方法。通常，最好用is_authenticated()方法。</li>
<li><code>is_authenticated()</code>:<br>永远返回True。该方法不代表该用户有任何的许可，也不代表该用户是active的，而只是表明该用户提供了正确的username和password。</li>
<li><code>get_full_name()</code>:<br>返回一个字符串，是first_name和last_name中间加一个空格组成。</li>
<li><code>set_password(raw_password)</code>:<br>调用该方法时候传入一个明文密码，该方法会进行hash转换。该方法调用之后并不会保存User对象。</li>
<li><code>check_password(raw_password)</code>：<br>如果传入的明文密码是正确的返回True。该方法和set_password是一对，也会考虑hash转换。</li>
<li>set_unusable_password()：<br>将用户设置为没有密码的状态。调用该方法后，check_password()方法将会永远返回false。但是如果，调用set_password()方法重新设置密码后，该方法将会失效，has_usable_password()也会返回True。</li>
<li>has_usable_password()：<br>在调用set_unusable_password()方法之后，该方法返回False，正常情况下返回True。</li>
<li><code>get_group_permissions(obj=None)</code>：<br>返回该用户通过组所拥有的许可（字符串列表每一个代表一个许可）。obj如果指定，将会返回关于该对象的许可，而不是模型。</li>
<li><code>get_all_permissions(obj=None)</code>:<br>返回该用户所拥有的所有的许可，包括通过组的和通过用户赋予的许可。</li>
<li><code>has_perm(perm,obj=None)</code>：<br>如果用户有传入的perm，则返回True。perm可以是一个格式为：’<app label="">.<permission codename="">‘的字符串。如果User对象为inactive，该方法永远返回False。和前面一样，如果传入obj，则判断该用户对于这个对象是否有这个许可。</permission></app></li>
<li>has_perms(perm_list,obj=None):<br>和has_perm一样，不同的地方是第一个参数是一个perm列表，只有用户拥有传入的每一个perm，返回值才是True。</li>
<li>has_module_perms(package_name)：<br>传入的是Django app label，按照’<app label="">.<permission codename="">‘格式。当用户拥有该app label下面所有的perm时，返回值为True。如果用户为inactive，返回值永远为False。</permission></app></li>
<li><code>email_user(subject,message,from_email=None)</code>：<br>发送一封邮件给这个用户，依靠的是该用户的email属性。如果from_email不提供的话，Django会使用settings中的DEFAULT_FROM_EMAIL发送。</li>
<li>get_profile()：<br>返回一个和Site相关的profile对象，用来存储额外的用户信息。</li>
</ol>
<p><strong>User对象的UserManager</strong>：</p>
<ul>
<li>create_user(username,email=None,password=None)</li>
<li>make_random_password(length=10,allowed_chars=’abcdefghjkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789’):该方法返回一个给定长度和允许字符集的密码。其中默认的allowed_chars有一些字符没有，比如i,l等等。</li>
</ul>
<h3 id="2-User-Profile"><a href="#2-User-Profile" class="headerlink" title="2.    User Profile"></a>2.    User Profile</h3><p><strong>使用UserProfile存储用户的额外信息 </strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class UserProfile(models.Model):</div><div class="line">    # 和User的一对一关系属性，该属性必填.</div><div class="line">    user = models.OneToOneField(User)</div><div class="line"> </div><div class="line">    # 其他需要存储的属性</div><div class="line">    # User因为是Django提供的，如果想要在其上增加一些自己需要的字段和方法，不太好加入，因此UserProfile是达成这个目标的一个有利工具</div><div class="line">    accepted_eula = models.BooleanField()</div><div class="line">    favorite_animal = models.CharField(max_length=20, default=&quot;Dragons.&quot;)</div></pre></td></tr></table></figure></p>
<p><strong>在settings中声明一个变量</strong><br>AUTH_PROFILE_MODULE = ‘accounts.UserProfile’</p>
<p>这样，User对象的get_profile()方法就会返回这个对象了。（UserProfile对象不会和User一起自动创建），因此要注册一个handler到User的post_save signal。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">from django.db.models.signals import post_save</div><div class="line"> </div><div class="line"># 定义了UserProfile</div><div class="line"># ...</div><div class="line"></div><div class="line">def create_user_profile(sender, instance, created, **kwargs):</div><div class="line">    if created:</div><div class="line">        UserProfile.objects.create(user=instance)</div><div class="line"> </div><div class="line">post_save.connect(create_user_profile, sender=User)</div></pre></td></tr></table></figure></p>
<h3 id="3-Login-Logout"><a href="#3-Login-Logout" class="headerlink" title="3.    Login Logout"></a>3.    Login Logout</h3><h4 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h4><p>需要两个函数：<code>authenticate(username,password)</code>和<code>login(request,user)</code>,位于django.contrib.auth模块中</p>
<ol>
<li><p>authenticate(usernae,password)函数需要两个参数username，password，如果校验通过则返回User对象，如果校验不通过返回None。</p>
</li>
<li><p>login接受两个参数，第一个是request对象，第二个是user对象。login方法使用SessionMiddleware将userID存入session当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">user = authenticate(username=username, password=password)</div><div class="line">if user is not None:</div><div class="line">    if user.is_active:</div><div class="line">        login(request, user)</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>check_password(password,encoded)</strong>：第一个参数是明文密码，第二个是加密过的密码。<br><strong>make_password(password[,salt,hashers])</strong>：根据给定的明文密码，salt，和Django支持的加密算法，返回一个加密的密码。<br><strong>is_password_unable(encoded_password)</strong>：判断是否给定字符串是一个hashed密码，有机会通过check_password()函数的校验。</p>
<blockquote>
<p>上述三个方法位于模块django.contrib.auth.hashers：</p>
</blockquote>
<h4 id="Logout"><a href="#Logout" class="headerlink" title="Logout"></a>Logout</h4><p><code>login(request)</code></p>
<h4 id="signals"><a href="#signals" class="headerlink" title="signals"></a>signals</h4><p><code>django.contrib.auth.signals.user_logged_in</code><br><code>django.contrib.auth.signals.user_logged_out</code><br>三个参数：</p>
<ol>
<li>sender：user的class，如果是logout事件该值有可能是None如果用户根本就没有验证通过。</li>
<li>request:HttpRequest对象</li>
<li>user:user对象，如果是logout事件该值有可能是None如果用户根本就没有验证通过。</li>
</ol>
<h4 id="decorator"><a href="#decorator" class="headerlink" title="decorator"></a>decorator</h4><p><code>django.contrib.auth.decorators.login_required([redirect_field_name=REDIRECT_FIELD_NAME,login_url=None])</code><br>两个参数：</p>
<ol>
<li>redirect_field_name:默认值是next。用来定义登陆成功之后的跳回之前访问界面的url。</li>
<li>login_url:默认值是settings.LOGIN_URL。用来指定登陆界面的url。如果不传入改参数，就需要确保settings.LOGIN_URL的值是正确设置的。</li>
</ol>
<h3 id="4-许可-Permission-和-用户组-Group"><a href="#4-许可-Permission-和-用户组-Group" class="headerlink" title="4.    许可(Permission) 和 用户组(Group)"></a>4.    许可(Permission) 和 用户组(Group)</h3><h4 id="许可（Permissions）"><a href="#许可（Permissions）" class="headerlink" title="许可（Permissions）"></a>许可（Permissions）</h4><p>django 会为每个用户给新出现的Model增加add,change,delete这三个权限。可以用任何一个user对象执行user.hash_perm(‘school.add_studygroup’)。——(add/change/delete，app:school，model:StudyGroup)，都会返回True。</p>
<p><code>自定义一些许可</code>：</p>
<ol>
<li>在Model类的meta属性中添加permissions定义。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Discussion(models.Model):</div><div class="line">    ...</div><div class="line">    class Meta:</div><div class="line">        permissions = (</div><div class="line">            (&quot;open_discussion&quot;, &quot;Can create a discussion&quot;),</div><div class="line">            (&quot;reply_discussion&quot;, &quot;Can reply discussion&quot;),</div><div class="line">            (&quot;close_discussion&quot;, &quot;Can remove a discussion by setting its status as closed&quot;),</div><div class="line">        )</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p> 模型类：Discussion。可以创建几个权限来对这个模型的权限许可进行控制，控制某些人可以发起讨论、发起回复，关闭讨论。</p>
</blockquote>
<ol>
<li>执行数据库迁移，数据库中就有这三个许可了。</li>
<li>之后可以将上面的权限赋予给用户，方法两种：<br> (1).通过某一个user的user_permissions属性：<br> user.user_permissions.add(permission, permission, …)<br> (2).通过user的一个组，然后通过Group的permissions属性：<br> group.permissions.add(permission, permission, …)</li>
</ol>
<blockquote>
<p>如果要判断一个用户是否有发表讨论的权限：user.has_perm(‘school.open_discussion’)　　</p>
</blockquote>
<p><strong>Permission 属性</strong><br>所属模块：django.contrib.auth.models<br>属性：</p>
<ol>
<li>name:必填。小于50个字符。例如：’Can publish’（描述）。</li>
<li>content_type：必填。一个指向django_content_type数据库表，对于每一个Django模型，在这个表里面都有一个记录对应。</li>
<li>codename：必填。小于100个字符。例如：’can_publish’。</li>
</ol>
<p><code>编程创建权限</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from django.contrib.auth.models import Group, Permission</div><div class="line">from django.contrib.contenttypes.models import ContentType</div><div class="line"> </div><div class="line">content_type = ContentType.objects.get(app_label=&apos;school&apos;, model=&apos;Discussion&apos;)</div><div class="line">permission = Permission.objects.create(codename=&apos;can_publish&apos;,</div><div class="line">                                       name=&apos;Can Publish Discussions&apos;,</div><div class="line">                                       content_type=content_type)</div></pre></td></tr></table></figure></p>
<p><code>在界面中使用许可</code>：<br>在模板代码中，有两个属性，是django给你提供好的，一个是user，一个是perms。</p>
<ol>
<li><p><strong>user：</strong><br>user变量是一个User或者AnoymousUser对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% if user.is_authenticated %&#125;</div><div class="line">    &lt;p&gt;Welcome, &#123;&#123; user.username &#125;&#125;. Thanks for logging in.&lt;/p&gt;</div><div class="line">&#123;% else %&#125;</div><div class="line">    &lt;p&gt;Welcome, new user. Please log in.&lt;/p&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>perms：</strong><br>perms变量是一个django.contrib.auth.context_processors.PermWrapper对象，对当前用户的User.has_module_perms和User.has_perm进行了封装。<br>比如判断当前用户是否拥有school应用下的所有权限，则使用<code></code><br>判断当前用户是否拥有school应用下发表讨论的权限，则使用<code></code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;% if perms.school %&#125;</div><div class="line">    &lt;p&gt;You have permission to do something in the school app.&lt;/p&gt;</div><div class="line">    &#123;% if perms.school.publish_discussion %&#125;</div><div class="line">        &lt;p&gt;You can discussion!&lt;/p&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% if perms.school.reply_discussion %&#125;</div><div class="line">        &lt;p&gt;You can reply discussion!&lt;/p&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&#123;% else %&#125;</div><div class="line">    &lt;p&gt;You don&apos;t have permission to do anything in the school app.&lt;/p&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>实现： settings 中的TEMPLATE_CONTEXT_PROCESSORS中定义的django.contrib.auth.context_processors.auth处理器。在django进入解析Template之前，首相要经过这一个个的context_processor。</p>
</blockquote>
<h4 id="用户组（Group）"><a href="#用户组（Group）" class="headerlink" title="用户组（Group）"></a>用户组（Group）</h4><p>其作用是在权限控制中可以批量对用户的许可进行分配。<br>将一个以后加入到一个Gruop中，该用户就拥有了所有该Group所分配的所有许可。</p>
<p><strong>Group 属性</strong></p>
<ol>
<li>name:必填。少于80个字符。</li>
<li>permissions:多对多引用。和user的user_permissions属性类型相同。我们可以通过下面代码给该组赋予权限。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">group.permissions = [permission_list]</div><div class="line">group.permissions.add(permission, permission, ...)</div><div class="line">group.permissions.remove(permission, permission, ...)</div><div class="line">group.permissions.clear()</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="5-Authentication-backends"><a href="#5-Authentication-backends" class="headerlink" title="5. Authentication backends"></a>5. Authentication backends</h3><p>django实现的这套permission体系，在底层被抽象为authentication backends。实际开发中可能需要对已有的权限系统进行扩展。<br>django中，所有的authentication backends，可以配置settings中一个 变量AUTHENTICATION_BACKENDS来做到，默认的设置：<br><code>AUTHENTICATION_BACKENDS = (&#39;django.contrib.auth.backends.ModelBackend&#39;,)</code></p>
<blockquote>
<p>校验：<br> user：authenticate(self,username=None,password=None) 或者authenticate(self,token=None)，get_user(self,user_id)<br> permission：get_group_permissions，get_all_permission，has_perm，has_module_perms</p>
</blockquote>
<h3 id="6-Django实现Object级别的权限控制－django-guardian"><a href="#6-Django实现Object级别的权限控制－django-guardian" class="headerlink" title="6.    Django实现Object级别的权限控制－django-guardian"></a>6.    Django实现Object级别的权限控制－django-guardian</h3><p><strong>安装配置django-guardian：</strong></p>
<ol>
<li>pip install django-guardian</li>
<li><p>在INSTALLED_APPS变量中加入guardian:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = (</div><div class="line">    &apos;guardian&apos;,</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>添加一个backend到AUTHENTICATION_BACKENDS中，这样django才会具有对对象的权限控制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AUTHENTICATION_BACKENDS = (</div><div class="line">    &apos;django.contrib.auth.backends.ModelBackend&apos;, # django默认的backend</div><div class="line">    &apos;guardian.backends.ObjectPermissionBackend&apos;,</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>在guardian中，还支持对匿名用户AnoymousUser的Object级别的权限控制。（比如说允许匿名用户发言的论坛或者blog）这需要在settings中加入：<code>ANONYMOUS_USER_ID=-1</code><br>之后执行数据库迁移，系统将会创建一个User实例，叫做AnonymouseUser</p>
</blockquote>
<p><strong>设置和使用对象权限</strong></p>
<p><code>guardian.shortcuts.assign(perm, user_or_group, obj=None)</code>，这个方法接受3个参数：</p>
<ol>
<li>perm<br>这个参数是一个字符串，代表一个许可，格式为<code>&lt;app&gt;.&lt;perm_codename&gt;</code>或者<code>&lt;perm_codename&gt;</code>格式，但如果第三个参数为None，则必须为前者格式。</li>
<li>user_or_group<br>这个参数是一个User或者Group类型的对象。</li>
<li>obj<br>这个参数就是相关的对象。可省略，若省略则赋予Model权限。</li>
</ol>
<p>【实例】<br>赋予模型级别的权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">from guardian.shortcuts import assign</div><div class="line">user = User.objects.create(username=&apos;zhangsan&apos;)</div><div class="line">assign(&apos;app.view_task&apos;,user)</div><div class="line">user.has_perm(&apos;app.view_task&apos;) &gt;&gt;&gt;True</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：一旦赋予模型级别的权限，那么所有该模型的对象级别的权限就都有了。</p>
</blockquote>
<p>赋予对象级别的权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">task = Task.objects.create(summary=&apos;Some job&apos;, content=&apos;&apos;)</div><div class="line">assign(&apos;app.view_task&apos;, user, task)</div><div class="line">user = User.objects.get(username=&apos;liuyong&apos;)#刷新缓存</div><div class="line">user.has_perm(&apos;app.view_task&apos;,task) &gt;&gt;&gt;True</div><div class="line">user.has_perm(&apos;app.view_task&apos;) &gt;&gt;&gt;False #模型级别的权限还没有</div></pre></td></tr></table></figure></p>
<blockquote>
<p>通过设置group来使用户具有相应的权限：<br>group = Group.objects.create(name=’employees’)<br>assign(‘change_task’, group, task)<br>user.groups.add(group)<br>user.has_perm(‘change_task’, task) &gt;&gt;&gt;True</p>
</blockquote>
<p>删除某个用户对某个对象的某种许可，这个函数的参数和assign相同。<br><code>guardian.shortcuts.remove_perm(perm,user_or_group=None, obj=None)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">from guardian.shortcuts import remove_perm</div><div class="line">remove_perm(&apos;change_site&apos;, user, site)</div><div class="line">user = User.objects.get(username=&apos;joe&apos;) #刷新user对象缓存</div><div class="line">user.has_perm(&apos;change_site&apos;, site)  &gt;&gt;&gt; False</div></pre></td></tr></table></figure></p>
<p><strong>Guardian在View中的使用</strong><br><code>guardian.shortcuts.get_perms(user_or_group,obj)</code>：返回user/group对象对obj对象所有的权限。<br><code>guardian.shortcuts.get_objects_for_user(user,perms,klass=None,use_groups=True,any_perm=False)</code>：获得该用户下指定perm列表中的所有对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">get_objects_for_user(user,&apos;app.change_post&apos;)# 返回可编辑帖子</div></pre></td></tr></table></figure></p>
<p><code>guadian.core.ObjectPermissionChecker</code>：该方法是一个用来判断权限的包装器，针对user和group提供权限相关的访问方法，主要有has_perm(perm,obj)和get_perms(obj)两个方法。并且提供缓存机制，在多次查找权限的时候可以使用它。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; epser = User.objects.get(username=&apos;esper&apos;)</div><div class="line">&gt;&gt;&gt; site = Site.objects.get_current()</div><div class="line">&gt;&gt;&gt; from guardian.core import ObjectPermissionChecker</div><div class="line">&gt;&gt;&gt; checker = ObjectPermissionChecker(esper) # 我们也可以传入组group对象</div><div class="line">&gt;&gt;&gt; checker.has_perm(&apos;change_site&apos;, site)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; checker.has_perm(&apos;add_site&apos;, site) # 这次将不会产生数据库查询</div><div class="line">False</div><div class="line">&gt;&gt;&gt; checker.get_perms(site)</div><div class="line">[u&apos;change_site&apos;]</div></pre></td></tr></table></figure></p>
<blockquote>
<p>【add】site = Site.objects.get_current()<br>等效于 current_site = Site.objects.get(id=settings.SITE_ID)<br>site模型管理器具备一个get_current()方法获得当前的站点域</p>
</blockquote>
<p><code>使用view的decorator</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; joe = User.objects.get(username=&apos;joe&apos;)</div><div class="line">&gt;&gt;&gt; foobars = Group.objects.create(name=&apos;foobars&apos;)</div><div class="line">&gt;&gt;&gt; from guardian.decorators import permission_required_or_403</div><div class="line">&gt;&gt;&gt; from django.http import HttpResponse</div><div class="line">&gt;&gt;&gt; @permission_required_or_403(&apos;auth.change_group&apos;,</div><div class="line">&gt;&gt;&gt;     (Group, &apos;name&apos;, &apos;group_name&apos;))</div><div class="line">&gt;&gt;&gt; def edit_group(request, group_name):</div><div class="line">&gt;&gt;&gt;     return HttpResponse(&apos;some form&apos;)</div></pre></td></tr></table></figure>
<p>只有拥有对name=foobars的Group对象拥有auth.change_group权限的用户，才能够执行这个view函数，否则返回的将是状态码为403的Response对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; request.user = joe</div><div class="line">&gt;&gt;&gt; joe.groups.add(foobars)</div><div class="line">&gt;&gt;&gt; edit_group(request, group_name=&apos;foobars&apos;)</div><div class="line">&lt;django.http.HttpResponse object at 0x102b8c8d0&gt; # view方法得以顺利访问了</div></pre></td></tr></table></figure></p>
<p><strong>Guardian在模版中的使用</strong><br>标签：<code>get_obj_perms</code><br>需要加载<code>guardian_tags</code>标签库 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% load guardian_tags %&#125;</div></pre></td></tr></table></figure></p>
<p>标签格式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% get_obj_perms user/group for obj as &quot;context_var&quot; %&#125;</div></pre></td></tr></table></figure></p>
<p>例子代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% get_obj_perms request.user for flatpage as &quot;flatpage_perms&quot; %&#125;</div><div class="line">&#123;% if &quot;delete_flatpage&quot; in flatpage_perms %&#125;</div><div class="line">    &lt;a href=&quot;/pages/delete?target=&#123;&#123; flatpage.url &#125;&#125;&quot;&gt;Remove page&lt;/a&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>
<p><strong>孤儿对象许可</strong><br>当我们删除User和相关的Object的时候，我们一定要删除其相关的所有UserObjectPermission和GroupObjectPermission对象。<br>三个处理方法：</p>
<ol>
<li>显式编码。</li>
<li><p>通过其提供的自定义django命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ python manage.py clean_orphan_obj_perms</div><div class="line">Removed 11 object permission entries with no targets</div></pre></td></tr></table></figure>
</li>
<li><p>定期调用guardian.utils.clean_orphan_obj_perms()，该函数会返回删除的对象数目，在python中，可以使用celery定期调度这个任务。</p>
</li>
</ol>
<p>最合理的解决办法，手动编码实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">from django.contrib.auth.models import User</div><div class="line">from django.contrib.contenttypes.models import ContentType</div><div class="line">from django.db.models import Q</div><div class="line">from django.db.models.signals import pre_delete</div><div class="line">from guardian.models import UserObjectPermission</div><div class="line">from guardian.models import GroupObjectPermission</div><div class="line">from school.models import StudyGroup</div><div class="line"></div><div class="line">def remove_obj_perms_connected_with_user(sender, instance, **kwargs):</div><div class="line">    filters = Q(content_type=ContentType.objects.get_for_model(instance),</div><div class="line">        object_pk=instance.pk)</div><div class="line">    UserObjectPermission.objects.filter(filters).delete()</div><div class="line">    GroupObjectPermission.objects.filter(filters).delete()</div><div class="line"> </div><div class="line">pre_delete.connect(remove_obj_perms_connected_with_user, sender=StudyGroup)</div></pre></td></tr></table></figure></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/django-primission/" rel="tag"># django-primission</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/05/jquery/" rel="next" title="jquery菜鸟教程学习笔记">
                <i class="fa fa-chevron-left"></i> jquery菜鸟教程学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/19/python2-7/" rel="prev" title="寥雪峰python2.7学习笔记">
                寥雪峰python2.7学习笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Iwhale" />
          <p class="site-author-name" itemprop="name">Iwhale</p>
          <p class="site-description motion-element" itemprop="description">Dream, Such as whales to the sea.</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/flyEn" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/p/1005055406757796/home" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-User-Model"><span class="nav-number">1.</span> <span class="nav-text">1.    User Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-User-Profile"><span class="nav-number">2.</span> <span class="nav-text">2.    User Profile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Login-Logout"><span class="nav-number">3.</span> <span class="nav-text">3.    Login Logout</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Login"><span class="nav-number">3.1.</span> <span class="nav-text">Login</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Logout"><span class="nav-number">3.2.</span> <span class="nav-text">Logout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signals"><span class="nav-number">3.3.</span> <span class="nav-text">signals</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#decorator"><span class="nav-number">3.4.</span> <span class="nav-text">decorator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-许可-Permission-和-用户组-Group"><span class="nav-number">4.</span> <span class="nav-text">4.    许可(Permission) 和 用户组(Group)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#许可（Permissions）"><span class="nav-number">4.1.</span> <span class="nav-text">许可（Permissions）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户组（Group）"><span class="nav-number">4.2.</span> <span class="nav-text">用户组（Group）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Authentication-backends"><span class="nav-number">5.</span> <span class="nav-text">5. Authentication backends</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Django实现Object级别的权限控制－django-guardian"><span class="nav-number">6.</span> <span class="nav-text">6.    Django实现Object级别的权限控制－django-guardian</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Thu Jan 05 2017 08:00:00 GMT+0800 (CST) - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Iwhale</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  

  

  

  

  


</body>
</html>
